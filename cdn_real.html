
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN源站扫描器</title>
    <!-- 引入 Element UI 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        }
        .main-container {
            padding: 30px;
        }
        .command-box {
            margin-top: 20px;
            background: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .el-row {
            margin-bottom: 20px;
        }
        .footer-button {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <el-header style="background-color: #409EFF; color: white; padding: 20px;">
                <h1 style="margin: 0;">CDN源站扫描器</h1>
            </el-header>
            <el-main class="main-container">
                <el-form :model="formData" label-position="top">
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="CIDR文件路径">
                                <el-input v-model="formData.cidrFile" placeholder="cidr.txt"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="端口">
                                <el-input v-model="formData.port" placeholder="80"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="带宽 (例如 10M, 100M)">
                                <el-input v-model="formData.bandwidth" placeholder="10M"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="域名 (例如 example.com)">
                                <el-input v-model="formData.domain" placeholder="example.com" :disabled="!formData.enableDomain"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="启用域名功能">
                                <el-switch v-model="formData.enableDomain" active-text="启用" inactive-text="禁用"></el-switch>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="HTTP方法 (例如 GET, POST)">
                                <el-input v-model="formData.httpMethod" placeholder="GET"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="请求路径 (例如 /login)">
                                <el-input v-model="formData.endpoint" placeholder="/login"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-form-item label="User-Agent">
                        <el-input v-model="formData.userAgent" placeholder="Mozilla/5.0..."></el-input>
                    </el-form-item>

                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="启用自定义HTTP头">
                                <el-switch v-model="formData.enableCustomHeaders" active-text="启用" inactive-text="禁用"></el-switch>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20" v-show="formData.enableCustomHeaders">
                        <el-col :span="8">
                            <el-form-item label="自定义HTTP头名称 (用|分隔)">
                                <el-input v-model="formData.customHeadersNames" placeholder="X-Forwarded-For"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="自定义HTTP头值 (用|分隔)">
                                <el-input v-model="formData.customHeadersValues" placeholder="127.0.0.1"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="自定义HTTP头分隔符">
                                <el-input v-model="formData.customHeadersDelimiter" placeholder="|"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20">
                        <el-col :span="6">
                            <el-form-item label="使用HTTPS">
                                <el-switch v-model="formData.useHttps"></el-switch>
                            </el-form-item>
                        </el-col>
                        <el-col :span="18">
                            <el-form-item label="查找内容 (用于grep)">
                                <el-input v-model="formData.searchString" placeholder="管理后台"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20">
                        <el-col :span="24">
                            <el-form-item label="启用排除功能">
                                <el-switch v-model="formData.enableExclude"></el-switch>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20" v-show="formData.enableExclude">
                        <el-col :span="18">
                            <el-form-item label="Exclude substrings (separated by |)">
                                <el-input v-model="formData.excludeStrings" placeholder="foo|bar"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item label="Exclude delimiter">
                                <el-input v-model="formData.excludeDelimiter" placeholder="|"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20">
                        <el-col :span="24">
                            <el-form-item label="Enable batch processing">
                                <el-switch v-model="formData.enableBatch"></el-switch>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20" v-show="formData.enableBatch">
                        <el-col :span="8">
                            <el-form-item label="Batch count (split IP list)">
                                <el-input-number v-model="formData.batchCount" :min="1" :max="100" placeholder="10"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="删除zgrab2数据">
                                <el-switch v-model="formData.cleanupZgrab2"></el-switch>
                                <div style="font-size: 12px; color: #909399; margin-top: 5px;">
                                    清理zgrab2生成的JSON文件
                                </div>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8">
                            <el-form-item label="删除zmap端口数据">
                                <el-switch v-model="formData.cleanupZmap"></el-switch>
                                <div style="font-size: 12px; color: #909399; margin-top: 5px;">
                                    清理zmap扫描的端口文件
                                </div>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="启用测试模式">
                                <el-switch v-model="formData.testMode"></el-switch>
                                <div style="font-size: 12px; color: #909399; margin-top: 5px;">
                                    开启后将跳过zmap扫描，直接使用指定的测试IP
                                </div>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12" v-show="formData.testMode">
                            <el-form-item label="测试IP地址">
                                <el-input v-model="formData.testIp" placeholder="192.168.1.1"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-form-item class="footer-button">
                        <el-button type="primary" @click="generateBashCommand" style="width: 100%">生成Bash命令</el-button>
                    </el-form-item>
                </el-form>

                <h2>生成的Bash命令</h2>
                <div class="command-box" v-html="bashCommand"></div>
            </el-main>
        </el-container>
    </div>

    <!-- 引入 Vue 和 Element UI -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    formData: {
                        cidrFile: 'cidr.txt',
                        port: '80',
                        bandwidth: '10M',
                        domain: 'example.com',
                        httpMethod: 'GET',
                        endpoint: '/login',
                        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0',
                        customHeadersNames: 'X-Forwarded-For',
                        customHeadersValues: '127.0.0.1',
                        customHeadersDelimiter: '|',
                        useHttps: false,
                        searchString: '管理后台',
                        excludeStrings: '',
                        excludeDelimiter: '|',
                        enableBatch: true,
                        batchCount: 10,
                        cleanupZgrab2: true,
                        cleanupZmap: true,
                        enableDomain: true,
                        enableCustomHeaders: false,
                        enableExclude: true,
                        testMode: false,
                        testIp: ''
                    },
                    bashCommand: ''
                };
            },
            mounted() {
                // 页面加载时自动读取保存的参数
                this.loadParameters();
            },
            methods: {
                generateBashCommand() {
                    const data = this.formData;
                    const openFile = `open_${data.port}.txt`;
                    const resultFile = `result_${data.domain}_${data.port}.txt`;

                    let command = '';

                    if (data.testMode) {
                        // 测试模式：直接使用测试IP
                        command += `<span style="color: #409EFF"># Test Mode: Using test IP</span>\n`;
                        if (data.enableDomain) {
                            command += `echo "${data.testIp},${data.domain}" > ${openFile}\n\n`;
                        } else {
                            command += `echo "${data.testIp}" > ${openFile}\n\n`;
                        }
                    } else {
                        // 正常模式：使用zmap扫描
                        command += `<span style="color: #409EFF"># Step 1: zmap scan</span>\n`;
                        command += `zmap -w ${data.cidrFile} -p ${data.port} -o ${openFile} --bandwidth=${data.bandwidth}\n\n`;

                        if (data.enableDomain) {
                            command += `<span style="color: #409EFF"># Step 2: Add domain to each IP</span>\n`;
                            command += `sed -i 's/$/,${data.domain}/g' ${openFile}\n\n`;
                        }
                    }

                    if (data.enableBatch) {
                        // Batch processing mode
                        const batchCount = data.batchCount || 10;

                        if (data.testMode) {
                            // 测试模式下直接处理单个IP，不需要分割
                            command += `<span style="color: #409EFF"># Test Mode: Direct processing</span>\n`;
                            command += `> ${resultFile}\n\n`;
                        } else {
                            command += `<span style="color: #409EFF"># Step 3: Split file into ${batchCount} batches</span>\n`;
                            command += `total_lines=$(wc -l < ${openFile})\n`;
                            command += `lines_per_batch=$((($total_lines + ${batchCount} - 1) / ${batchCount}))\n`;
                            command += `split -l $lines_per_batch ${openFile} ${openFile.replace('.txt', '_')}\n`;
                            command += `for file in ${openFile.replace('.txt', '_')}*; do mv "$file" "$file.txt"; done\n\n`;

                            command += `<span style="color: #409EFF"># Step 4: Initialize result file</span>\n`;
                            command += `> ${resultFile}\n\n`;
                        }

                        command += `<span style="color: #409EFF"># Step 5: Process each batch</span>\n`;
                        command += `batch_num=1\n`;
                        if (data.testMode) {
                            command += `batch_file=${openFile}\n`;
                        } else {
                            command += `for batch_file in ${openFile.replace('.txt', '_')}*.txt; do\n`;
                            command += `    echo "Processing batch $batch_num: $batch_file"\n`;
                        }
                        command += `    \n`;
                        command += `    # zgrab2 scan for current batch\n`;
                        command += `    zgrab2_output="zgrab2_${data.domain}_${data.port}_batch_$batch_num.json"\n`;
                        command += `    docker run --rm -i -v $(pwd):/root/zmap_scan ghcr.io/zmap/zgrab2 -f=/root/zmap_scan/$batch_file -o=/root/zmap_scan/$zgrab2_output http \\\n`;
                        command += `      --method=${data.httpMethod} \\\n`;
                        if (data.enableDomain) {
                            command += `      --server-name="${data.domain}" \\\n`;
                        }
                        command += `      --endpoint="${data.endpoint}" \\\n`;
                        command += `      --user-agent="${data.userAgent}" \\\n`;
                        if (data.useHttps) {
                            command += `      --use-https \\\n`;
                        }
                        if (data.enableCustomHeaders && data.customHeadersNames) {
                            command += `      --custom-headers-names="${data.customHeadersNames}" \\\n`;
                            command += `      --custom-headers-values="${data.customHeadersValues}" \\\n`;
                            command += `      --custom-headers-delimiter="${data.customHeadersDelimiter}" \\\n`;
                        }
                        command += `      --port=${data.port}\n`;
                        command += `    \n`;
                        command += `    # Extract and append results\n`;
                        const escapeForShell = s => s.replace(/["$`\\{}]/g, m => `\\${m}`);
                        let extractCmd = `    cat $zgrab2_output | grep "${escapeForShell(data.searchString)}"`;
                        if (data.enableExclude && data.excludeStrings) {
                            const delimiter = (data.excludeDelimiter && data.excludeDelimiter.length > 0) ? data.excludeDelimiter : '|';
                            const parts = (data.excludeStrings || '').split(delimiter).map(s => s.trim()).filter(s => s.length > 0);
                            if (parts.length > 0) {
                                const excludeArgs = parts.map(p => `-e "${escapeForShell(p)}"`).join(' ');
                                extractCmd += ` | grep -Fv ${excludeArgs}`;
                            }
                        }
                        extractCmd += ` | jq -r '.ip + ":${data.port}"' >> ${resultFile}\n`;
                        command += extractCmd;
                        command += `    \n`;

                        if (data.cleanupZgrab2) {
                            command += `    # Cleanup intermediate files\n`;
                            if (data.cleanupZgrab2) {
                                command += `    rm -f $zgrab2_output\n`;
                                command += `    rm -f $batch_file\n`;
                            }
                        }
                        command += `    \n`;
                        command += `    batch_num=$((batch_num + 1))\n`;
                        if (!data.testMode) {
                            command += `done\n\n`;
                        } else {
                            command += `\n`;
                        }

                        if (data.cleanupZmap) {
                            command += `<span style="color: #409EFF"># Step 6: Final cleanup</span>\n`;
                            if (data.testMode) {
                                command += `rm -f ${openFile}\n\n`;
                            } else {
                                command += `rm -f ${openFile}\n`;
                                command += `rm -f ${openFile.replace('.txt', '_')}*.txt\n\n`;
                            }
                        }

                        command += `<span style="color: #409EFF"># Step 7: Display results</span>\n`;
                        command += `echo "Batch processing completed. Results saved to ${resultFile}"\n`;
                        command += `echo "Total results found: $(wc -l < ${resultFile})"\n`;

                    } else {
                        // Non-batch processing mode (original logic)
                        const zgrab2File = `zgrab2_${data.domain}_${data.port}.json`;

                        command += `<span style="color: #409EFF"># Step 3: zgrab2 send HTTP${data.useHttps ? 'S' : ''} requests</span>\n`;
                        command += `docker run --rm -i -v $(pwd):/root/zmap_scan ghcr.io/zmap/zgrab2 -f=/root/zmap_scan/${openFile} -o=/root/zmap_scan/${zgrab2File} http \\\n`;
                        command += `  --method=${data.httpMethod} \\\n`;
                        if (data.enableDomain) {
                            command += `  --server-name="${data.domain}" \\\n`;
                        }
                        command += `  --endpoint="${data.endpoint}" \\\n`;
                        command += `  --user-agent="${data.userAgent}" \\\n`;
                        if (data.useHttps) {
                            command += `  --use-https \\\n`;
                        }
                        if (data.enableCustomHeaders && data.customHeadersNames) {
                            command += `  --custom-headers-names="${data.customHeadersNames}" \\\n`;
                            command += `  --custom-headers-values="${data.customHeadersValues}" \\\n`;
                            command += `  --custom-headers-delimiter="${data.customHeadersDelimiter}" \\\n`;
                        }
                        command += `  --port=${data.port}\n\n`;

                        command += `<span style="color: #409EFF"># Step 4: Extract results</span>\n`;
                        const escapeForShell = s => s.replace(/["$`\\{}]/g, m => `\\${m}`);
                        let extractCmd = `cat ${zgrab2File} | grep "${escapeForShell(data.searchString)}"`;
                        if (data.enableExclude && data.excludeStrings) {
                            const delimiter = (data.excludeDelimiter && data.excludeDelimiter.length > 0) ? data.excludeDelimiter : '|';
                            const parts = (data.excludeStrings || '').split(delimiter).map(s => s.trim()).filter(s => s.length > 0);
                            if (parts.length > 0) {
                                const excludeArgs = parts.map(p => `-e "${escapeForShell(p)}"`).join(' ');
                                extractCmd += ` | grep -Fv ${excludeArgs}`;
                            }
                        }
                        extractCmd += ` | jq -r '.ip + ":${data.port}"' > ${resultFile}\n\n`;
                        command += extractCmd;

                        command += `<span style="color: #409EFF"># Step 5: Display results</span>\n`;
                        command += `echo "Scan completed. Results saved to ${resultFile}"\n`;
                        command += `echo "Total results found: $(wc -l < ${resultFile})"\n`;
                    }

                    this.bashCommand = command;
                    // 保存参数到localStorage
                    this.saveParameters();
                },
                
                // 保存参数到localStorage
                saveParameters() {
                    try {
                        const params = JSON.stringify(this.formData);
                        localStorage.setItem('cdn_finder_params', params);
                        console.log('参数已保存到localStorage');
                    } catch (error) {
                        console.error('保存参数失败:', error);
                    }
                },
                
                // 从localStorage加载参数
                loadParameters() {
                    try {
                        const savedParams = localStorage.getItem('cdn_finder_params');
                        if (savedParams) {
                            const params = JSON.parse(savedParams);
                            // 合并保存的参数到当前formData，保持默认值
                            Object.assign(this.formData, params);
                            console.log('参数已从localStorage加载');
                        }
                    } catch (error) {
                        console.error('加载参数失败:', error);
                    }
                }
            }
        });
    </script>
</body>
</html>
